<?xml version="1.0" encoding="UTF-8"?>

<!--
  Demo route retrieving temperature values from OPC-UA server and forwarding only the
  raw value to some REST API.
-->
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:camel="http://camel.apache.org/schema/blueprint"
           xmlns:jaxrs="http://cxf.apache.org/blueprint/jaxrs"
           xsi:schemaLocation="
               http://cxf.apache.org/schemas/blueprint/jaxrs.xsd
               http://camel.apache.org/schema/blueprint
               http://camel.apache.org/schema/blueprint/camel-blueprint.xsd
              http://camel.apache.org/schema/spring">
    <camelContext xmlns="http://camel.apache.org/schema/blueprint" id="opcua-rest-demo">
      <route rest="true" id="OPC-UA Demo">
        <!-- Retrieve temperature values from sample OPC-UA server -->
        <from uri="milo-client:tcp://localhost:4840/?node=RAW(ns=1;i=2002)&amp;samplingInterval=100"/>
        <log message="Received from OPC-UA: ${body.value.value}"/>
        
        <!-- Extract only temp value from overall DataValue object -->
        <setBody>
          <simple>${body.value.value}</simple>
        </setBody>
        
        <!-- Convert into sth. streamable (was double, now is utf-8 encoded byte array -->
        <convertBodyTo type="java.lang.String"/>

        <!-- We want HTTP POST -->
        <setHeader headerName="CamelHttpMethod">
          <constant>POST</constant>
        </setHeader>

        <!-- Set Mime type -->
        <setHeader headerName="Exchange.CONTENT_TYPE">
            <constant>application/json</constant>
        </setHeader>

        <!-- Send to REST API -->
        <to uri="http://ids.aisec.fraunhofer.de/rest/temp"/>
        <log message="REST API responds: ${body}"/>
      </route>
    </camelContext>
</blueprint>
